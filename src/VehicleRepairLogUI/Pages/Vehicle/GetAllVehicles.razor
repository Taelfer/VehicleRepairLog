@page "/vehicles"

@attribute [Authorize]

@inject IVehicleService vehicleService 
@inject NavigationManager navigationManager

<h1>Vehicles List</h1>
<hr />

@if(vehicles is null)
{
    <p>Loading...</p>
}
else
{
    <button type="button" class="btn btn-primary" @onclick="@(async () => await AddVehicleForm())"> Add Vehicle </button>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Vehicle Name</th>
                <th>Image</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach(var vehicle in vehicles)
            {
                <tr>
                    <td>
                        <a class="nav-link" href="vehicleProfile/@vehicle.Id"> @vehicle.BrandName </a>
                    </td>
                    <td></td>
                    <td>
                        <button class="btn btn-primary" type="button"
                                        @onclick="@(() => AddRepairAsync(vehicle.Id))"> Add Repair </button>
                        <button class="btn btn-danger" type="button"
                                        @onclick="@(() => DisplayDeleteConfirmationPopUpForm(vehicle.Id))"> Delete </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <AddVehicle
        Vehicle="Vehicle"
        Show="ShowAddVehicleForm"
        OnConfirm="@(async () => await ConfirmAddVehicle())"
        OnCancel="CancelVehicleForm"/>

    <DeleteConfirmationPopUpForm 
        Show="ShowDeleteConfirmationPopUpForm"
        OnCancel="CancelDeleteConfirmationPopUpform"
        OnDelete="@(async () => await ConfirmDelete())" />
}

@code {
    protected IEnumerable<VehicleDto> vehicles;
    protected IEnumerable<RepairDto>? repairs;

    [Parameter] public VehicleDto Vehicle { get; set; } = new VehicleDto();
    [Parameter] public bool ShowAddVehicleForm { get; set; }
    [Parameter] public bool ShowDeleteConfirmationPopUpForm { get; set; }
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; }

    protected override async Task OnInitializedAsync()
    {
        vehicles = await vehicleService.GetAllVehiclesAsync();
    }

    protected async Task AddRepairAsync(int vehicleId)
    {
        navigationManager.NavigateTo($"/vehicle/{vehicleId}/addRepair", true);
    }

    protected async Task AddVehicleForm()
    {
        AuthenticationState authState = await AuthState;

        // Stores User ID taken from AuthenticationState.
        int userId = Convert.ToInt32(authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value);

        // Assigns User ID to Vehicle.
        Vehicle.UserId = userId;

        ShowAddVehicleForm = true;
    }

    protected void CancelVehicleForm()
    {
        ShowAddVehicleForm = false;
    }

    protected async Task ConfirmAddVehicle()
    {
        await vehicleService.AddVehicleAsync(Vehicle);

        await OnInitializedAsync();

        ShowAddVehicleForm = false;
    }

    protected async Task ConfirmDelete()
    {
        await vehicleService.DeleteVehicleAsync(Vehicle.Id);

        await OnInitializedAsync();

        ShowDeleteConfirmationPopUpForm = false;
    }

    public void DisplayDeleteConfirmationPopUpForm(int vehicleId)
    {
        Vehicle.Id = vehicleId;

        ShowDeleteConfirmationPopUpForm = true;
    }

    public void CancelDeleteConfirmationPopUpform()
    {
        ShowDeleteConfirmationPopUpForm = false;
    }
}
